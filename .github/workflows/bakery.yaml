on:
  pull_request:

name: Examples - Bakery
jobs:

  collect-examples:
    name: Collect bakery examples
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect numbered bakery directories
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          # Find numbered directories under bakery/ (e.g., 01-basic-image, 02-multiple-images)
          entries=$(ls -d bakery/[0-9]*/ 2>/dev/null | while read dir; do
              name=$(basename "$dir")
              echo "$name"
          done | jq -R -s -c 'split("\n")[:-1] | map({name: .})')

          # Create the matrix JSON
          matrix=$(echo $entries | jq -c '{include: .}')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  build-and-test:
    needs:
      - collect-examples
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.collect-examples.outputs.matrix)}}
    name: Build and test - ${{ matrix.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: posit
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Goss
        uses: posit-dev/images-shared/setup-goss@main

      - name: Set up Bakery
        uses: posit-dev/images-shared/setup-bakery@main

      - name: Set up Just
        uses: extractions/setup-just@v2

      - name: Add tools to PATH
        run: echo "$GITHUB_WORKSPACE/tools" >> $GITHUB_PATH

      - name: Build example
        env:
          EXAMPLE_NAME: ${{ matrix.name }}
        run: just --justfile bakery/Justfile build "$EXAMPLE_NAME"

      - name: Test example
        env:
          EXAMPLE_NAME: ${{ matrix.name }}
        run: just --justfile bakery/Justfile test "$EXAMPLE_NAME"
